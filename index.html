<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Geotag - Draggable</title>
    <style>
        :root {
            --primary-color: #2e7d32;
            --accent-color: #ffeb3b;
            --bg-color: #f1f8e9;
            --panel-bg: #ffffff;
            --text-main: #1b5e20;
            --text-secondary: #424242;
            --font-stack: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-stack);
            background-color: var(--bg-color);
            color: var(--text-secondary);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .app-container { display: flex; width: 100%; height: 100%; }

        /* Sidebar Controls */
        .controls {
            width: 380px;
            background: var(--panel-bg);
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: 2px 0 15px rgba(0,0,0,0.05);
            z-index: 10;
            overflow-y: auto;
        }

        .preview-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background-color: #c8e6c9;
            background-image: radial-gradient(#a5d6a7 15%, transparent 16%), radial-gradient(#a5d6a7 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            overflow: hidden;
            padding: 40px;
        }

        /* --- FORM ELEMENTS --- */
        h1 { font-size: 22px; color: var(--text-main); margin-bottom: 5px; }
        p.subtitle { font-size: 13px; color: #757575; margin-bottom: 25px; }
        
        .form-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 15px; }
        label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #7cb342; }
        
        input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }
        textarea { resize: vertical; min-height: 80px; }

        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .btn-upload {
            background-color: #f1f8e9;
            color: var(--text-main);
            border: 2px dashed #c5e1a5;
            width: 100%;
        }
        .btn-upload:hover { background-color: #dcedc8; border-color: #9ccc65; }
        
        .btn-download {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
            margin-top: 10px;
        }
        .btn-download:hover { background-color: #1b5e20; transform: translateY(-1px); }

        /* --- PREVIEW & OVERLAY --- */
        .image-wrapper {
            position: relative;
            box-shadow: 0 15px 50px rgba(0,0,0,0.2);
            max-width: 100%;
            max-height: 85vh;
            user-select: none;
            line-height: 0;
        }
        
        #source-image {
            max-width: 100%;
            max-height: 85vh;
            display: block;
            pointer-events: none;
        }

        /* The Geotag Overlay */
        #geotag-overlay {
            position: absolute;
            /* Initial position set by JS */
            background-color: rgba(232, 245, 233, 0.9);
            backdrop-filter: blur(2px);
            border-radius: 12px;
            padding: 15px 20px;
            cursor: move; /* Indicates draggable */
            font-family: 'Segoe UI', sans-serif;
            color: #000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            width: 55%;
            touch-action: none; /* Important for mobile drag */
        }
        
        #geotag-overlay:active {
            cursor: grabbing;
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
            transform: scale(1.01);
        }

        /* Overlay Internal Structure */
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        
        .badge {
            background-color: var(--accent-color);
            color: #000;
            font-weight: 800;
            font-size: 14px;
            padding: 4px 10px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .time {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(180deg, #2196f3 0%, #0d47a1 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            line-height: 1;
        }

        .date { font-size: 15px; font-weight: 600; color: #1b5e20; margin-bottom: 12px; }

        .address-block {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            align-items: flex-start;
        }
        
        .accent-line {
            width: 3px;
            background-color: var(--accent-color);
            border-radius: 1.5px;
            flex-shrink: 0;
            align-self: stretch;
        }

        .address {
            font-size: 13px;
            color: #2e7d32;
            line-height: 1.4;
            word-break: break-word;
        }

        .divider { height: 1px; background-color: rgba(0,0,0,0.1); margin-bottom: 10px; }

        .footer {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 500;
            color: #1b5e20;
        }
        .shield-icon { width: 14px; height: 16px; fill: currentColor; }

        .empty-state { text-align: center; color: #7cb342; }
        
        /* Resize Handle (Optional but good to keep from previous version) */
        .resize-handle {
            width: 20px;
            height: 20px;
            background: rgba(0,0,0,0.1);
            border: 2px solid white;
            border-radius: 50%;
            position: absolute;
            bottom: -10px;
            right: -10px;
            cursor: nwse-resize;
            opacity: 0;
            transition: opacity 0.2s;
        }
        #geotag-overlay:hover .resize-handle { opacity: 1; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- CONTROLS SIDEBAR -->
        <aside class="controls">
            <div>
                <h1>Geotag Attendance</h1>
                <p class="subtitle">Drag & Drop to reposition stamp.</p>
            </div>

            <div class="form-group">
                <label>1. Upload Photo</label>
                <input type="file" id="file-input" accept="image/*" class="hidden">
                <button class="btn btn-upload" onclick="document.getElementById('file-input').click()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    Choose Image
                </button>
            </div>

            <div id="settings-panel" class="hidden">
                <div class="form-group">
                    <label>Label Text</label>
                    <input type="text" id="inp-label" value="ABSENSI">
                </div>

                <div class="form-group">
                    <label>Time (HH:MM)</label>
                    <input type="text" id="inp-time" value="08:00">
                </div>

                <div class="form-group">
                    <label>Date</label>
                    <input type="text" id="inp-date" value="Wednesday, 25 Oct 2023">
                </div>

                <div class="form-group">
                    <label>Location Address</label>
                    <textarea id="inp-address">Jl. Jendral Sudirman Kav. 1, Central Jakarta, Indonesia.</textarea>
                </div>

                <div class="form-group">
                    <label>Photo Code</label>
                    <input type="text" id="inp-code" value="Photo Code: ID-882-X92">
                </div>

                <button class="btn btn-download" id="btn-download">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Download 2K Image
                </button>
            </div>
        </aside>

        <!-- PREVIEW AREA -->
        <main class="preview-area" id="drop-zone">
            <div class="empty-state" id="empty-msg">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
                <p style="margin-top:10px;">Upload a photo to start</p>
            </div>

            <div class="image-wrapper hidden" id="img-container">
                <img id="source-image" alt="Source">
                
                <!-- OVERLAY (Draggable) -->
                <div id="geotag-overlay">
                    <div class="header-row">
                        <div class="badge" id="dom-label">ABSENSI</div>
                        <div class="time" id="dom-time">08:00</div>
                    </div>
                    <div class="date" id="dom-date">Wednesday, 25 Oct 2023</div>
                    <div class="address-block">
                        <div class="accent-line" id="dom-line"></div>
                        <div class="address" id="dom-address">...</div>
                    </div>
                    <div class="divider"></div>
                    <div class="footer">
                        <svg class="shield-icon" viewBox="0 0 24 24">
                            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>
                        </svg>
                        <span id="dom-code">Photo Code: XXXXXXXX</span>
                    </div>
                    
                    <!-- RESIZE HANDLE -->
                    <div class="resize-handle" id="resize-handle"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- CONFIG ---
        const TARGET_LONG_SIDE = 2048;
        const DEFAULT_OVERLAY_WIDTH_PERCENT = 0.55;
        
        // --- STATE ---
        const state = {
            img: null,
            // Dragging State
            isDragging: false,
            isResizing: false,
            dragStart: { x: 0, y: 0 },
            initialPos: { x: 0, y: 0 },
            initialDim: { w: 0, h: 0 },
            
            // Position (Relative to image container)
            pos: { x: 20, y: 20 }, 
            
            scale: 1.0,
            initialWidth: 0
        };

        // --- DOM ELEMENTS ---
        const els = {
            fileInput: document.getElementById('file-input'),
            dropZone: document.getElementById('drop-zone'),
            sourceImage: document.getElementById('source-image'),
            imgContainer: document.getElementById('img-container'),
            emptyMsg: document.getElementById('empty-msg'),
            settingsPanel: document.getElementById('settings-panel'),
            overlay: document.getElementById('geotag-overlay'),
            resizeHandle: document.getElementById('resize-handle'),
            
            inpLabel: document.getElementById('inp-label'),
            inpTime: document.getElementById('inp-time'),
            inpDate: document.getElementById('inp-date'),
            inpAddress: document.getElementById('inp-address'),
            inpCode: document.getElementById('inp-code'),
            
            domLabel: document.getElementById('dom-label'),
            domTime: document.getElementById('dom-time'),
            domDate: document.getElementById('dom-date'),
            domAddress: document.getElementById('dom-address'),
            domCode: document.getElementById('dom-code'),
            domLine: document.getElementById('dom-line')
        };

        // --- EVENT LISTENERS ---
        els.fileInput.addEventListener('change', handleFile);
        els.dropZone.addEventListener('dragover', (e) => { e.preventDefault(); });
        els.dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            if (e.dataTransfer.files.length) handleFile({ target: { files: e.dataTransfer.files } });
        });

        // Input Updates
        [els.inpLabel, els.inpTime, els.inpDate, els.inpAddress, els.inpCode].forEach(inp => {
            inp.addEventListener('input', updateDOMText);
        });

        document.getElementById('btn-download').addEventListener('click', generateExport);

        // --- DRAG & RESIZE LOGIC ---
        els.overlay.addEventListener('mousedown', (e) => {
            if(e.target === els.resizeHandle) return;
            state.isDragging = true;
            state.dragStart.x = e.clientX;
            state.dragStart.y = e.clientY;
            state.initialPos.x = state.pos.x;
            state.initialPos.y = state.pos.y;
        });

        els.resizeHandle.addEventListener('mousedown', (e) => {
            e.stopPropagation();
            state.isResizing = true;
            state.dragStart.x = e.clientX;
            state.initialDim.w = els.overlay.offsetWidth;
            state.initialWidth = els.overlay.offsetWidth; // Reset base width for scale calc
        });

        window.addEventListener('mousemove', (e) => {
            if (state.isDragging) {
                const dx = e.clientX - state.dragStart.x;
                const dy = e.clientY - state.dragStart.y;
                
                let newX = state.initialPos.x + dx;
                let newY = state.initialPos.y + dy;
                
                // Boundary Check
                const maxX = els.imgContainer.offsetWidth - els.overlay.offsetWidth;
                const maxY = els.imgContainer.offsetHeight - els.overlay.offsetHeight;
                
                state.pos.x = Math.max(0, Math.min(newX, maxX));
                state.pos.y = Math.max(0, Math.min(newY, maxY));
                
                updatePosition();
            } else if (state.isResizing) {
                const dx = e.clientX - state.dragStart.x;
                const newWidth = state.initialDim.w + dx;
                const newScale = Math.max(0.5, Math.min(newWidth / state.initialWidth, 1.5));
                state.scale = newScale;
                updateSize();
            }
        });

        window.addEventListener('mouseup', () => {
            state.isDragging = false;
            state.isResizing = false;
        });
        
        // Touch support for dragging
        els.overlay.addEventListener('touchstart', (e) => {
             if(e.target === els.resizeHandle) return;
             state.isDragging = true;
             const touch = e.touches[0];
             state.dragStart.x = touch.clientX;
             state.dragStart.y = touch.clientY;
             state.initialPos.x = state.pos.x;
             state.initialPos.y = state.pos.y;
        });
        window.addEventListener('touchmove', (e) => {
            if(!state.isDragging) return;
            const touch = e.touches[0];
            const dx = touch.clientX - state.dragStart.x;
            const dy = touch.clientY - state.dragStart.y;
            let newX = state.initialPos.x + dx;
            let newY = state.initialPos.y + dy;
            const maxX = els.imgContainer.offsetWidth - els.overlay.offsetWidth;
            const maxY = els.imgContainer.offsetHeight - els.overlay.offsetHeight;
            state.pos.x = Math.max(0, Math.min(newX, maxX));
            state.pos.y = Math.max(0, Math.min(newY, maxY));
            updatePosition();
        });
        window.addEventListener('touchend', () => {
            state.isDragging = false;
        });

        // --- CORE LOGIC ---
        function handleFile(e) {
            if (!e.target.files.length) return;
            const file = e.target.files[0];
            if (!file.type.startsWith('image/')) return alert('Please upload an image.');

            const reader = new FileReader();
            reader.onload = (evt) => {
                els.sourceImage.src = evt.target.result;
                els.sourceImage.onload = () => {
                    state.img = els.sourceImage;
                    els.emptyMsg.classList.add('hidden');
                    els.imgContainer.classList.remove('hidden');
                    els.settingsPanel.classList.remove('hidden');
                    resetOverlay();
                    updateDOMText();
                }
            };
            reader.readAsDataURL(file);
        }

        function resetOverlay() {
            // Default to Bottom-Left with Padding
            const containerW = els.imgContainer.offsetWidth;
            const containerH = els.imgContainer.offsetHeight;
            const padding = 30;
            const targetW = containerW * DEFAULT_OVERLAY_WIDTH_PERCENT;
            
            state.initialWidth = targetW;
            state.scale = 1.0;
            
            els.overlay.style.width = targetW + 'px';
            updateSize();

            // Calculate Position
            state.pos.x = padding;
            state.pos.y = containerH - els.overlay.offsetHeight - padding;
            updatePosition();
        }

        function updatePosition() {
            els.overlay.style.left = state.pos.x + 'px';
            els.overlay.style.top = state.pos.y + 'px';
            els.domLine.style.height = els.domAddress.offsetHeight + 'px';
        }

        function updateSize() {
            const s = state.scale;
            const baseW = els.imgContainer.offsetWidth * DEFAULT_OVERLAY_WIDTH_PERCENT;
            const finalW = baseW * s;
            els.overlay.style.width = finalW + 'px';

            // Apply Scale to Fonts/Padding
            els.overlay.style.padding = (15 * s) + 'px ' + (20 * s) + 'px';
            els.overlay.style.borderRadius = (12 * s) + 'px';
            els.domLabel.style.fontSize = (14 * s) + 'px';
            els.domTime.style.fontSize = (32 * s) + 'px';
            els.domDate.style.fontSize = (15 * s) + 'px';
            els.domAddress.style.fontSize = (13 * s) + 'px';
            els.domCode.style.fontSize = (12 * s) + 'px';
            
            // Margin adjustments
            els.domDate.style.marginBottom = (12 * s) + 'px';
            els.domAddress.parentElement.style.marginBottom = (12 * s) + 'px';
            document.querySelector('.divider').style.marginBottom = (10 * s) + 'px';
            document.querySelector('.footer').style.gap = (8 * s) + 'px';
            
            els.domLine.style.height = els.domAddress.offsetHeight + 'px';
        }

        function updateDOMText() {
            els.domLabel.textContent = els.inpLabel.value;
            els.domTime.textContent = els.inpTime.value;
            els.domDate.textContent = els.inpDate.value;
            els.domAddress.textContent = els.inpAddress.value;
            els.domCode.textContent = els.inpCode.value;
            els.domLine.style.height = els.domAddress.offsetHeight + 'px';
        }

        // --- EXPORT LOGIC (SCALED & ACCURATE) ---
        function generateExport() {
            if (!state.img) return;
            const btn = document.getElementById('btn-download');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Rendering...';

            setTimeout(() => {
                try {
                    const imgW = state.img.naturalWidth;
                    const imgH = state.img.naturalHeight;
                    
                    // 1. Calculate 2K Dimensions
                    let canvasW, canvasH;
                    if (imgW > imgH) {
                        canvasW = TARGET_LONG_SIDE;
                        canvasH = (TARGET_LONG_SIDE / imgW) * imgH;
                    } else {
                        canvasH = TARGET_LONG_SIDE;
                        canvasW = (TARGET_LONG_SIDE / imgH) * imgW;
                    }

                    // 2. Calculate Export Scale (DOM -> Canvas)
                    const domW = els.imgContainer.offsetWidth;
                    const domH = els.imgContainer.offsetHeight;
                    const exportScale = canvasW / domW; 

                    const canvas = document.createElement('canvas');
                    canvas.width = canvasW;
                    canvas.height = canvasH;
                    const ctx = canvas.getContext('2d');
                    
                    // High Quality Settings
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';

                    // Draw Image
                    ctx.drawImage(state.img, 0, 0, canvasW, canvasH);

                    // Draw Overlay using DOM coordinates * exportScale
                    drawOverlayOnCanvas(ctx, canvasW, canvasH, exportScale);

                    // Download
                    const link = document.createElement('a');
                    link.download = `geotag_${Date.now()}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.95);
                    link.click();

                } catch(e) {
                    console.error(e);
                    alert('Error generating image.');
                } finally {
                    btn.innerHTML = originalText;
                }
            }, 100);
        }

        function drawOverlayOnCanvas(ctx, cw, ch, scale) {
            const s = scale * state.scale; // Combined scale
            
            const padX = 20 * s;
            const padY = 15 * s;
            
            const baseW = cw * DEFAULT_OVERLAY_WIDTH_PERCENT;
            const overlayW = baseW * state.scale; 
            
            // CRITICAL: Convert DOM Pixel Position to Canvas Position
            const x = state.pos.x * scale;
            const y = state.pos.y * scale;

            // Calculate Height based on content
            ctx.font = `800 ${14 * s}px 'Segoe UI'`;
            const badgeH = 24 * s;
            const dateH = 20 * s;
            
            ctx.font = `normal ${13 * s}px 'Segoe UI'`;
            const maxAddrW = overlayW - (padX * 2) - (3 * s) - (10 * s);
            const addrLines = getWrappedLines(ctx, els.inpAddress.value, maxAddrW);
            const addrH = addrLines.length * (13 * s * 1.4);
            
            const footerH = 20 * s;
            const dividerM = 12 * s;
            const totalH = badgeH + (12*s) + dateH + (12*s) + addrH + dividerM + 1 + footerH + (padY*2);

            // 1. Background
            ctx.fillStyle = "rgba(232, 245, 233, 0.9)";
            roundRect(ctx, x, y, overlayW, totalH, 12 * s);
            ctx.fill();

            // 2. Badge
            const badgeText = els.inpLabel.value;
            ctx.fillStyle = "#ffeb3b";
            const badgeWText = ctx.measureText(badgeText).width + (10 * s * 2);
            roundRect(ctx, x + padX, y + padY, badgeWText, badgeH, 4 * s);
            ctx.fill();
            ctx.fillStyle = "#000";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.font = `800 ${14 * s}px 'Segoe UI'`;
            ctx.fillText(badgeText, x + padX + badgeWText/2, y + padY + badgeH/2);

            // 3. Time
            const timeText = els.inpTime.value;
            ctx.save();
            ctx.font = `800 ${32 * s}px 'Segoe UI'`;
            const timeW = ctx.measureText(timeText).width;
            const timeX = x + overlayW - padX - timeW;
            const timeY = y + padY + badgeH/2;
            
            ctx.beginPath();
            ctx.rect(timeX, timeY - (16*s), timeW, 32*s);
            ctx.clip();
            const grad = ctx.createLinearGradient(0, timeY - (16*s), 0, timeY + (16*s));
            grad.addColorStop(0, "#2196f3");
            grad.addColorStop(1, "#0d47a1");
            ctx.fillStyle = grad;
            ctx.textBaseline = "alphabetic";
            ctx.fillText(timeText, timeX, timeY + (4*s));
            ctx.restore();

            // 4. Date
            ctx.fillStyle = "#1b5e20";
            ctx.font = `600 ${15 * s}px 'Segoe UI'`;
            ctx.textAlign = "left";
            ctx.textBaseline = "top";
            let currY = y + padY + badgeH + (12 * s);
            ctx.fillText(els.inpDate.value, x + padX, currY);

            // 5. Address
            currY += dateH + (12 * s);
            ctx.fillStyle = "#ffeb3b";
            const lineW = 3 * s;
            ctx.fillRect(x + padX, currY, lineW, addrH);
            
            ctx.fillStyle = "#2e7d32";
            const textX = x + padX + lineW + (10 * s);
            addrLines.forEach((line, i) => {
                ctx.fillText(line, textX, currY + (i * (13 * s * 1.4)));
            });
            currY += addrH;

            // 6. Divider
            currY += dividerM;
            ctx.fillStyle = "rgba(0,0,0,0.1)";
            ctx.fillRect(x + padX, currY, overlayW - (padX*2), 1);

            // 7. Footer
            currY += 10 * s;
            const shieldS = 16 * s;
            ctx.fillStyle = "#1b5e20";
            ctx.save();
            ctx.translate(x + padX, currY);
            ctx.scale(shieldS/24, shieldS/24);
            ctx.beginPath();
            ctx.moveTo(12, 1); ctx.lineTo(3, 5); ctx.lineTo(3, 11);
            ctx.bezierCurveTo(3, 16.55, 6.84, 21.74, 12, 23);
            ctx.bezierCurveTo(17.16, 21.74, 21, 16.55, 21, 11);
            ctx.lineTo(21, 5); ctx.lineTo(12, 1);
            ctx.fill();
            ctx.restore();

            ctx.font = `500 ${12 * s}px 'Segoe UI'`;
            ctx.textBaseline = "middle";
            ctx.fillText(els.inpCode.value, x + padX + shieldS + (8*s), currY + (shieldS/2));
        }

        function roundRect(ctx, x, y, w, h, r) {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.arcTo(x + w, y, x + w, y + h, r);
            ctx.arcTo(x + w, y + h, x, y + h, r);
            ctx.arcTo(x, y + h, x, y, r);
            ctx.arcTo(x, y, x + w, y, r);
            ctx.closePath();
        }

        function getWrappedLines(ctx, text, maxWidth) {
            const words = text.split(" ");
            let lines = [];
            let currentLine = words[0];
            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = ctx.measureText(currentLine + " " + word).width;
                if (width < maxWidth) {
                    currentLine += " " + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }
    </script>
</body>
</html>
